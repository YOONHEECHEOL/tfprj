<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layout/cli_layout">

<th:block layout:fragment="content">

    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>

    <t-h1 ko="ì˜ˆì•½ê²°ì œ" en="RES-PAY"></t-h1>

    <input type="hidden" id="resId" th:value="${res.getResId()}">
    <input type="hidden" id="gameId" th:value="${game.getGameId()}">

    <table class="table">
        <thead></thead>
    </table>

    <span th:text="${res.getResId()}"></span><br>
    <span th:text="${#dates.format(res.getStartTime(), 'yy-MM-dd HH:mm') + ' - ' + #dates.format(res.getEndTime(), 'HH:mm')}"></span>
    <input type="hidden" th:value="${#dates.format(res.getStartTime(), 'HH')}" id="startTime">
    <input type="hidden" th:value="${#dates.format(res.getEndTime(), 'HH')}" id="endTime">
<!--    <span th:text="${#dates.format(res.getEndTime(), 'HH:mm')}"></span><br>-->
<!--    <span th:text="${res.getGameId()}"></span><br>-->
<!--    <span th:text="${res.getMemberId()}"></span><br>-->
<!--    <span th:text="${res.getMemberName()}"></span><br>-->
<!--    <span th:text="${res.getResDate()}"></span><br>-->
<!--    <span th:text="${res.getResId()}"></span><br>-->
<!--    <span th:text="${res.getRoom()}"></span><br>-->
<!--    <span th:text="${res.getStatusCd()}"></span><br>-->
<!--    <span th:text="${res.getTel()}"></span><br><br>-->

    <hr>

<!--    <span th:text="${game.getRoom()}"></span>-->
<!--    <span th:text="${game.getResId()}"></span>-->
<!--    <span th:text="${game.getMemberName()}"></span>-->
<!--    <span th:text="${game.getGameId()}"></span>-->
<!--    <span th:text="${game.getAwayHits()}"></span>-->
<!--    <span th:text="${game.getAwayPlayteamCd()}"></span>-->
<!--    <span th:text="${game.getAwayScore()}"></span>-->
<!--    <span th:text="${game.getHomeHits()}"></span>-->
<!--    <span th:text="${game.getInnings()}"></span>-->
    <span th:text="${game.getGameId()}"></span>

    <div class="message-caution">
        ê²°ì œ ì·¨ì†Œ ì‹œ ì˜ˆì•½ì´ ì·¨ì†Œë©ë‹ˆë‹¤.<br>
        <span>ğŸ“¢ í˜„ì¥ê²°ì œ ë° ë¬´í†µì¥ ì…ê¸ˆì€ ê´€ë¦¬ì í™•ì¸ í›„ ê²°ì œì™„ë£Œë©ë‹ˆë‹¤.</span>
    </div>

    <ul id="paymentMethod">
        <li><button class="c-button" data-val="1701">í˜„ì¥ê²°ì œ</button></li>
        <li><button class="c-button" data-val="1702">ë„¤ì´ë²„í˜ì´</button></li>
        <li><button class="c-button" data-val="1703">ì¹´ì¹´ì˜¤í˜ì´</button></li>
        <li><button class="c-button" data-val="1704">ë¬´í†µì¥ì…ê¸ˆ</button></li>
    </ul>

    <div class="button__box">




    </div>

    <div class="button__box">
        <button class="button button-common" onclick="resCancel()">ì·¨ì†Œí•˜ê¸°</button>
        <a class="button button-primary" onclick="pay()">ê²°ì œí•˜ê¸°</a>
    </div>

    <!-- ê²°ì œ ê±´ form -->
    <form action="/cli/resPayDone" method="get" id="payDoneFrm">

        <input type="hidden" value="" id="paymentAmount" name="paymentAmount">
        <input type="hidden" value="1501" id="prodInfoCd" name="prodInfoCd">
        <input type="hidden" th:value="${#session.getAttribute('memberId')}" id="memberId" name="memberId">
        <input type="hidden" value="" id="paymentMethodCd" name="paymentMethodCd">
        <input type="hidden" value="" id="paymentStatusCd" name="paymentStatusCd">

    </form>

    <script>

        let $startTime = document.querySelector('#startTime').value;
        let $endTime = document.querySelector('#endTime').value;

        // paymentAmount value insert
        let $paymentAmount = ($endTime - $startTime) * 50000;
        document.querySelector('#paymentAmount').value = $paymentAmount;

        const paymentMethod = () => {
            let t = document.querySelector('#paymentMethod');

            t.addEventListener('click', () => {
                if(event.target.tagName === 'BUTTON') {
                    removeActive();
                    let val = event.target.getAttribute('data-val');
                    document.querySelector('#paymentMethodCd').value = val;
                    event.target.classList.add('active')

                    if(val == 1701 || val == 1704) {
                        document.querySelector('#paymentStatusCd').value = 801;
                    } else {
                        document.querySelector('#paymentStatusCd').value = 802;
                    }
                }
            })
        }

        const removeActive = () => {
            let tg = document.querySelector('#paymentMethod').children
            for(let i=0; i<tg.length; i++) {
                tg[i].querySelector('button').classList.remove('active')
            }
        }

        paymentMethod()

        // ì·¨ì†Œ ì‹œ Reservation, Game, Member-Game table ì—ì„œ í•´ë‹¹ ì˜ˆì•½ê³¼ ê´€ë ¨ëœ ê±´ ëª¨ë‘ ì‚­ì œ
        const resCancel = () => {
            // res ì²˜ë¦¬ë¥¼ ìœ„í•œ param ê°’
            let $resId = document.querySelector('#resId').value;

            // game ì²˜ë¦¬ë¥¼ ìœ„í•œ param ê°’
            let $gameId = document.querySelector('#gameId').value;

            location.href = '/cli/resPayCancel?resId=' + $resId + '&gameId=' + $gameId;
        }


        // ê²°ì œí•˜ê¸°
        const pay = () => {
            let t = document.querySelector('#paymentMethod');
            let c = $("#paymentMethod")
            let payMethod = document.querySelector('.c-button.active').getAttribute("data-val");
            if(payMethod == 1703){
                alert('ì¹´ì¹´ì˜¤í˜ì´ ì„ íƒ');
                var IMP = window.IMP; // ìƒëµê°€ëŠ¥
                IMP.init('imp66037800'); // 'iamport' ëŒ€ì‹  ë¶€ì—¬ë°›ì€ "ê°€ë§¹ì  ì‹ë³„ì½”ë“œ"ë¥¼ ì‚¬ìš©
                var msg;

                IMP.request_pay({
                    pg : 'html5_inicis',
                    pay_method : 'card',
                    merchant_uid : 'merchant_' + new Date().getTime(),
                    name : 'KH Books ë„ì„œ ê²°ì œ',
                    amount : 500,
                    buyer_email : '<%=email%>',
                    buyer_name : '<%=name%>',
                    buyer_tel : '<%=phone%>',
                    buyer_addr : '<%=address%>',
                    buyer_postcode : '123-456',
                    //m_redirect_url : 'http://localhost:18000/cli/home'
                },function (rsp) {
                    if (rsp.success) { // ê²°ì œ ì„±ê³µ ì‹œ: ê²°ì œ ìŠ¹ì¸ ë˜ëŠ” ê°€ìƒê³„ì¢Œ ë°œê¸‰ì— ì„±ê³µí•œ ê²½ìš°
                        console.log(rsp)
                        $.ajax({
                            url : "worker_hrm_list"
                        }).done(function(response){
                            $('#payDoneFrm').submit();
                        })

                    } else {
                        alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì—ëŸ¬ ë‚´ìš©: " +  rsp.error_msg);
                    }
                });
            }
            else if(payMethod == 1702){
                alert('ë„¤ì´ë²„ ì„ íƒ');
            }


            // t.addEventListener('click', () => {
            //     if(event.target.tagName === 'BUTTON') {
            //         let val = event.target.getAttribute('data-val');
            //         document.querySelector('#paymentMethodCd').value = val;
            //         if(val == 1703){
            //             alert("ì¹´ì¹´ì˜¤í˜ì´ ì„ íƒ~")
            //         }
            //
            //         if(val == 1701 || val == 1704) {
            //             document.querySelector('#paymentStatusCd').value = 801;
            //         } else {
            //             document.querySelector('#paymentStatusCd').value = 802;
            //         }
            //     }
            // })

            //validate ì¶”ê°€
        }

    </script>


</th:block>

</html>