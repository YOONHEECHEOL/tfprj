<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layout/cli_layout">

<th:block layout:fragment="content">
    <!--    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">-->
    <!--    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->

    <t-h1 ko="ì˜ˆì•½" en="RES"></t-h1>

    <input type="hidden" th:value="${reservation.getResId()}" id="currentResId">
    <input type="hidden" th:value="${#session.getAttribute('memberId')}" id="currentMemberId">

    <!--    <div class="row align-items-center px-0">-->
    <!--        <div class="col-12">-->
    <!--            <span id="dateVal" class="bf-3" th:text="${#dates.format(reservation.startTime, 'yyyy-MM-dd')}" onchange="reservedTimeCheck()" readonly></span>-->
    <!--        </div>-->
    <!--    </div>-->
    <!-- ë‚ ì§œ ë³€ê²½ ê¸°ëŠ¥ í˜„ì¬ë¶ˆê°€ -->
    <!--    <input th:type="button" class="c-button" id="rsvBtn" th:value="ë‚ ì§œë³€ê²½">-->

    <!--    <div class="row steps">-->
    <!--        <div th:id="1" class="col-4 active"><span>step01</span><br>íŒ€ì„ íƒ</div>-->
    <!--        <div th:id="2" class="col-4"><span>step02</span><br>ë©¤ë²„ì…ë ¥</div>-->
    <!--        <div th:id="3" class="col-4"><span>step03</span><br>ì´ë‹</div>-->
    <!--    </div>-->

    <div class="row steps">
        <div class="col-4 tablinks active" data-no="1" onclick="openCity(event, 'team')">
            <span>step01</span>
            <b>íŒ€ì„ íƒ</b>
            <i class="fa-solid fa-baseball-bat-ball"></i>
        </div>
        <div class="col-4 tablinks" data-no="2" onclick="openCity(event, 'member')">
            <span>step02</span>
            <b>ë©¤ë²„ì…ë ¥</b>
            <i class="fa-solid fa-people-group"></i>
        </div>
        <div class="col-4 tablinks" data-no="3" onclick="openCity(event, 'inning')">
            <span>step03</span>
            <b>ì´ë‹</b>
            <i class="fa-solid fa-baseball"></i>
        </div>
    </div>

    <!-- validate box -->
    <div class="row v-step">
        <div class="col-4 px-0"></div>
        <div class="col-4 px-0"></div>
        <div class="col-4 px-0"></div>
    </div>


    <div id="team" class="tabcontent" style="display: block">
        <!-- team -->
        <div class="g__box">
            <div class="row align-items-center">
                <div class="col">
                    <span class="bf-2">ë‚ ì§œ</span>
                </div>
                <div class="col">
            <span class="bf-2"
                  th:text="|${#dates.format(reservation.startTime, 'yy-MM-dd')}|"></span>
                </div>
            </div>

            <div class="row align-items-center">
                <div class="col">
                    <span class="bf-2">ì‹œê°„</span>
                </div>
                <div class="col">
            <span class="bf-2"
                  th:text="|${#dates.format(reservation.startTime, 'HH:mm')} - ${#dates.format(reservation.endTime, 'HH:mm')}|"></span>
                </div>
            </div>

            <div class="row align-items-center">
                <div class="col">
                    <span class="bf-2">êµ¬ì¥</span>
                </div>
                <div class="col">
                    <span class="bf-2" id="roomNo" th:data-room="${reservation.room}"
                          th:text="|${reservation.room} êµ¬ì¥|"></span>
                </div>
            </div>
        </div>

        <hr>

        <div class="row mt20" id="selectTeam">
            <div class="col-12">
                <span class="bf-4">íŒ€</span>
            </div>

            <div class="col-6">
                <div class="bf-2 text-center">í™ˆíŒ€</div>
                <button class="c-button bb" id="homeTeam" onclick="openTeamModal()">íŒ€ ì„ íƒ</button>
            </div>
            <div class="col-6">
                <div class="bf-2 text-center">ì›ì •íŒ€</div>
                <button class="c-button bb" id="awayTeam" onclick="openTeamModal()">íŒ€ ì„ íƒ</button>
            </div>
        </div>

        <hr class="mt20">

        <div class="message-success">
            <span>ğŸ“¢ [íŒ€ ì„ íƒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</span>
        </div>

        <div id="team-modal" class="modal">
            <div class="bf-3 text-center mb20">í”„ë¡œíŒ€ ëª©ë¡</div>
            <ul id="team-list">
                <li data-code="101">ì‚¼ì„±ë¼ì´ì˜¨ì¦ˆ</li>
                <li data-code="102">KIAíƒ€ì´ê±°ì¦ˆ</li>
                <li data-code="103">í•œí™”ì´ê¸€ìŠ¤</li>
                <li data-code="104">ë‘ì‚°ë² ì–´ìŠ¤</li>
                <li data-code="105">SSGëœë”ìŠ¤</li>
                <li data-code="106">í‚¤ì›€íˆì–´ë¡œì¦ˆ</li>
                <li data-code="107">LGíŠ¸ìœˆìŠ¤</li>
                <li data-code="108">NCë‹¤ì´ë…¸ìŠ¤</li>
                <li data-code="109">KTWIZ</li>
            </ul>
            <div class="message-success mt20">
                ì›í•˜ì‹œëŠ” í”„ë¡œíŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”!<br>
                <span>ğŸ“¢ í”„ë¡œíŒ€ì„ ê¼­ ì…ë ¥í•´ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤.</span>
            </div>

            <hr>

            <div class="button__box mt20">
                <button class="button button-common" id="cancel-team-modal" onclick="cancelBtnFnc()">ì·¨ì†Œí•˜ê¸°</button>
                <button class="button button-primary" id="select-team" onclick="cancelBtnFnc()">ì„ íƒí•˜ê¸°</button>
            </div>
        </div>

        <script>
            let tmpTg = '';

            // ì§„í–‰ë„ ë”í•˜ê¸°
            const chkProgress = (i) => {
                let v = document.querySelector('.v-step').children;
                v[i].classList.add('checked');
            }

            // modal ì—´ê¸°
            const openTeamModal = () => {
                tmpTg = event.target.getAttribute('id');

                $('#team-modal').fadeIn()

                // selectTeamValue(tmpTg);
            }

            const selectTeamValue = (tgName) => {
                let selectTeam = document.querySelector('#select-team');
                let tg = document.querySelector('#' + tgName)

                tg.innerText = selectTeam.getAttribute('team');
                tg.setAttribute('data-code', selectTeam.getAttribute('data-code'));
            }

            // team-list add eventListener
            document.querySelector('#team-list').addEventListener('click', () => {
                removeSelectedCss();
                let selectTeam = document.querySelector('#select-team');
                selectTeam.setAttribute('data-code', event.target.getAttribute('data-code'));
                selectTeam.setAttribute('team', event.target.innerText);
                event.target.classList.add('selected');
            })

            const insertValue = (tgName) => {
                const rr = document.querySelector('#' + tgName);
                let selectTeam = document.querySelector('#select-team');

                console.log(rr)
                rr.innerText = selectTeam.getAttribute('team');
                rr.setAttribute('data-code', selectTeam.getAttribute('data-code'));

            }
            // ì·¨ì†Œë²„íŠ¼
            const cancelBtnFnc = () => {
                let ii = '#team-modal';
                removeSelectedCss()
                cancelTeamModal(ii);

                // validation bar ì˜¬ë¦¬ê¸°
                let a = document.querySelector('#homeTeam').getAttribute('data-code')
                let b = document.querySelector('#awayTeam').getAttribute('data-code')

                if (a != null && b != null) {
                    chkProgress(0);
                }
            }
            // ë‹«ê¸°
            const cancelTeamModal = (target) => {
                selectTeamValue(tmpTg);

                $(target).fadeOut();
            }
            const removeSelectedCss = () => {
                document.querySelectorAll('#team-list > li').forEach(l => {
                    l.removeAttribute('class');
                })
            }
        </script>
        <!-- //team -->
    </div>

    <div id="member" class="tabcontent">
        <!-- member -->
        <div class="row" id="memberSelect">
            <div class="col-12">
                <span class="bf-4">ë©¤ë²„</span>
            </div>
            <div class="col-6">
                <div class="bf-2 text-center">í™ˆíŒ€</div>
                <div>
                    <select id="homeNum" class="form-control-lg" onchange="homeMemberNum()">
                        <option>ë©¤ë²„ìˆ˜</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
                <div id="homeDiv">

                </div>
            </div>
            <div class="col-6 ">
                <div class="bf-2 text-center">ì›ì •íŒ€</div>
                <div>
                    <select id="awayNum" class="form-control-lg" onchange="awayMemberNum()">
                        <option>ë©¤ë²„ìˆ˜</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
                <div id="awayDiv">

                </div>
            </div>
        </div>

        <hr class="mt20">

        <div class="message-success mt20">
            <span>ğŸ“¢ ê²½ê¸°ì— ì°¸ê°€í•  ì¸ì› ìˆ˜ ë§Œí¼ ì…ë ¥ í›„<br>ê¸°ë¡ ì…ë ¥ì„ ì›í•˜ì‹œëŠ” ë¶„ì€ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!</span>
        </div>
        <!-- //member -->
    </div>

    <div id="inning" class="tabcontent">
        <!-- inning -->
        <span class="bf-4">ì´ë‹</span>
        <div class="button__box" id="inningValue">
            <button class="c-button" data-val="3">3 ì´ë‹</button>
            <button class="c-button" data-val="6">6 ì´ë‹</button>
            <button class="c-button" data-val="9">9 ì´ë‹</button>
        </div>

        <hr class="mt20">

        <div class="message-success mt20">
            <span>ğŸ“¢ ì˜ˆì•½í•˜ì‹œëŠ” ê²½ê¸°ì˜<br>ì´ ì´ë‹ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!</span>
        </div>
        <!-- //inning -->
    </div>

    <!-- buttons -->
    <div class="res-button-box">
        <div class="button__box col-12">
            <a th:href="${'/cli/deleteReservation?resId=' + reservation.getResId()}" class="button button-common" id="cancel">ì·¨ì†Œ</a>
            <button class="button button-primary" id="prevBtn" onclick="prevFnc()">ì´ì „</button>
            <button class="button button-primary" id="nextBtn" onclick="nextFnc()">ë‹¤ìŒ</button>
            <button class="button button-danger dp-none" id="submitBtn" data-chk="n" onclick="finalDataProcessing()">ì œì¶œ</button>
        </div>
    </div>

    <!-- modal tab menu ìš© script -->
    <script>
        let tabChk = 0;

        const selectInning = () => {
            document.querySelector('#inningValue').addEventListener('click', () => {
                if (event.target.tagName == 'BUTTON') {
                    removeSelected('.' + event.target.className)
                    let val = event.target.getAttribute('data-val');
                    event.target.classList.add('active');
                    chkProgress(2);

                    // validate
                    validateFrm()
                }
            })
        }
        selectInning()

        const removeSelected = (t) => {
            let group = document.querySelectorAll(t);
            group.forEach(i => i.className = i.className.replace(' active', ''))
        }

        // nextBtn, prevBtn ì´ë²¤íŠ¸
        function prevFnc() {
            if (tabChk !== 0) {
                tabChk = tabChk - 1;

                // tabContent hide
                hideTabContent()

                // tablinks active ì‹œí‚¤ê¸°
                removeTabAttr()

                let submitBtn = document.querySelector('#submitBtn')
                let submitBtnChk = submitBtn.getAttribute('data-chk')

                submitBtn.classList.add('dp-none')
                nextBtn.classList.remove('dp-none')

                let tablinks = document.getElementsByClassName("tablinks");
                tablinks[tabChk].className += " active";

                let tabcontent = document.getElementsByClassName("tabcontent");
                tabcontent[tabChk].style.display = "block";
            }

        }

        function nextFnc() {
            if (tabChk !== 2) {
                tabChk = tabChk + 1;

                // tabContent hide
                hideTabContent()

                // tablinks active ì‹œí‚¤ê¸°
                removeTabAttr()

                let tablinks = document.getElementsByClassName("tablinks");
                tablinks[tabChk].className += " active";

                let tabcontent = document.getElementsByClassName("tabcontent");
                tabcontent[tabChk].style.display = "block";
            }
        }

        function openCity(evt, cityName) {
            hideTabContent();
            removeTabAttr();
            displayContent(evt, cityName);
        }

        const hideTabContent = () => {
            let tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
        }
        const removeTabAttr = () => {
            let tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
        }
        const displayContent = (evt, cityName) => {
            document.getElementById(cityName).style.display = "block";
            evt.currentTarget.className += " active";
        }

    </script>


    <!-- ê²€ìƒ‰ìš© ëª¨ë‹¬ -->
    <div th:class="modal" id="search-modal">
        <div th:class="modal-content">
            <t-h2 ko="íšŒì›ê²€ìƒ‰"></t-h2>
            <input type="text" class="form-control-lg" id="searchVal"
                   name="searchVal" placeholder="Search"
                   aria-label="Search">

            <button class="c-button mt20" id="searchBtn"
                    type="button"><i class="fa-solid fa-magnifying-glass"></i> Search
            </button>

            <div class="bf-3 mt20">ê²€ìƒ‰ê²°ê³¼</div>
            <table class="table a-table">
                <tbody th:id="memberList" >

                </tbody>
            </table>

            <hr class="mt20">

            <input type="hidden" id="btnId">
            <input type="hidden" id="difficultyVal">
            <!-- ì—¬ê¸°ì„œ -->

            <div class="dp-none" id="diff_box">
                <div class="bf-3 mt20">ë‚œì´ë„ ì…ë ¥</div>
                <!-- ë‚œì´ë„ ì…ë ¥ -->
                <div id="diff-list" class="button__box">
                    <button class="c-button" data-code="201">ì•„ë§ˆì¶”ì–´</button>
                    <button class="c-button" data-code="202">ì„¸ë¯¸í”„ë¡œ</button>
                    <button class="c-button" data-code="203">í”„ë¡œ</button>
                </div>
            </div>


            <hr class="mt20">

            <div class="button__box mt20">
                <button class="button button-common" id="cancelBtn">ì·¨ì†Œí•˜ê¸°</button>
                <button class="button button-primary" id="regMemberBtn">ì…ë ¥í•˜ê¸°</button>
            </div>
        </div>
    </div>


    <script th:defer th:src="@{/js/ssgjs.js}"></script>

    <script>
        let memberInsertList = [];
        let bbbb = 0;

        // ì œì¶œí•˜ê¸° ë²„íŠ¼
        const validateFrm = () => {
            let submitBtn = document.querySelector('#submitBtn')
            let submitBtnChk = submitBtn.getAttribute('data-chk')
            let nextBtn = document.querySelector('#nextBtn')
            let inningsVal = document.querySelector('#inningValue > .active').getAttribute('data-val')
            if (inningsVal != null) {
                nextBtn.classList.add('dp-none')
                submitBtn.classList.remove('dp-none')
            }
        }

        // insert game
        const insertGame = () => {
            return new Promise(async (res, rej) => {

                let memberId = document.querySelector('#currentMemberId').getAttribute('value');
                if (memberId == '') {
                    memberId = 'ë¹„íšŒì›';
                }
                let inningsVal = document.querySelector('#inningValue > .active').getAttribute('data-val')

                // data ìƒì„±í•˜ê¸°
                let gameInfo = {
                    'resId': document.querySelector('#currentResId').value,
                    'memberId': memberId,
                    'memberName': memberId,
                    'innings': inningsVal,
                    'homePlayteamCd': document.querySelector('#homeTeam').getAttribute('data-code'),
                    'awayPlayteamCd': document.querySelector('#awayTeam').getAttribute('data-code'),
                    'room': document.querySelector('#roomNo').getAttribute('data-room')
                }
                console.log(gameInfo);
                // ajax insert ì²˜ë¦¬
                await fetch('/cli/insertGame', {
                    method: 'post',
                    headers: {'Content-type': 'application/json'},
                    body: JSON.stringify(gameInfo)
                })
                    .then(res => res.text())
                    .then(res => {
                        bbbb = res;
                    })

                res('insertMemberGame function ì‹¤í–‰í•´ì£¼ì„¸ìš”!')
            })
        }


        const insertMemberGame = (res) => {
            return new Promise(async (res, rej) => {
                let gcd = 1;

                for (const l of memberInsertList) {
                    // data ìƒì„±
                    let memberGameInfo = {
                        'memberId': l.id,
                        'memberName': l.id,
                        'groundCd': gcd,
                        'difficultyCd': l.difficulty,
                        'gameId': bbbb
                    }

                    // ë°°ì—´ ìˆ˜ì— ë§ê²Œ insert ì²˜ë¦¬
                    await fetch('/cli/insertMemberGame', {
                        method: 'post',
                        headers: {'Content-type': 'application/json'},
                        body: JSON.stringify(memberGameInfo)
                    })
                        .then(res => res.text())
                        .then(res => console.log(res))

                }
                res('member-game insert ì²˜ë¦¬ë¨.')
            })
        }

        const redirectPayPage = (res) => {
            console.log(res);
            return new Promise(async (res, rej) => {
                let resNo = document.querySelector('#currentResId').value;
                location.href = '/cli/resPay?resNo=' + resNo + '&gameId=' + bbbb;
            })
        }

        // ìµœì¢… Game, Member-Game insert ì²˜ë¦¬ ì‹¤í–‰ í•¨ìˆ˜
        const finalDataProcessing = () => {
            if (confirm('í•´ë‹¹ ë‚´ìš©ìœ¼ë¡œ ì˜ˆì•½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                insertGame()
                    .then(res => insertMemberGame(res))
                    .then(res => redirectPayPage(res))
            }

        }


        document.querySelector('#diff-list').addEventListener('click', () => {
            // attr remove
            let tg = document.querySelector('#diff-list').children;
            for (i = 0; i < tg.length; i++) {
                tg[i].className = tg[i].className.replace(" active", "");
            }


            let txtVal = event.target.innerText;
            let codeVal = event.target.getAttribute('data-code');
            event.target.classList.add('active')

            let tt = document.querySelector('#difficultyVal');
            tt.setAttribute('value', txtVal);
            tt.setAttribute('data-code', codeVal);
        })

        const checkStep2 = () => {
            // validation bar ì˜¬ë¦¬ê¸°
            let a = document.querySelector('#homeMembers')
            let b = document.querySelector('#awayMembers')
            console.log(a)
            console.log(b)

            if (a !== null && b !== null) {
                chkProgress(1);
            }
        }

        function homeMemberNum() {
            $("#homeMembers").remove();

            let homeNum = document.getElementById("homeNum")

            let homeNumId = homeNum.options[homeNum.selectedIndex].value;

            if (homeNumId.trim()) {
                console.log(homeNumId)
                let $div = $("<div>");

                $div.attr('id', 'homeMembers');
                $div.attr('class', 'res-member');
                $("#homeDiv").append($div);

                for (let i = 0; i < homeNumId; i++) {
                    let html = "";
                    html += `<div><button id=h` + (i + 1) + ` onclick="memberInsert(this)">`
                    html += (i + 1) + `ë²ˆ ë©¤ë²„ ì…ë ¥</button>`
                    $("#homeMembers").append(html);

                }
            }
            checkStep2()
        }

        function awayMemberNum() {
            $("#awayMembers").remove();

            let awayNum = document.getElementById("awayNum")
            let awayNumId = awayNum.options[awayNum.selectedIndex].value;

            if (awayNumId.trim()) {
                console.log(awayNumId)
                let $div = $("<div>");

                $div.attr('id', 'awayMembers');
                $div.attr('class', 'res-member');
                $("#awayDiv").append($div);
                for (let i = 0; i < awayNumId; i++) {
                    let html = "";
                    html += `<div><button  id=a` + (i + 1) + ` onclick="memberInsert(this)">`
                    html += (i + 1) + `ë²ˆ ë©¤ë²„ ì…ë ¥</button>`
                    $("#awayMembers").append(html);
                }
            }
            checkStep2()
        }
    </script>
    <script>
        let ccc;

        function memberInsert(e) {
            let btnId = e.getAttribute("id");
            $("#search-modal").fadeIn();
            $("#btnId").val(btnId);

        }

        //ì·¨ì†Œ ë²„íŠ¼
        $("#cancelBtn").on("click", function () {

            $("#search-modal").fadeOut();

        })

        //search ë²„íŠ¼ í´ë¦­ì‹œ ë©¤ë²„ ê²€ìƒ‰ ajaxí˜¸ì¶œ
        $("#searchBtn").on("click", function () {
            $.ajax({
                url: "/cli/searchMember",
                data: {memberId: $("#searchVal").val()}
            }).done(function (data) {
                $("#memberList").html('');
                for (list of data) {
                    $("#memberList").append(makeTr(list));
                }

                // ë‚œì´ë„ ë²„íŠ¼ ìƒì„±
                $('#diff_box').attr('class', ' ')
            })
        })

        //ê²€ìƒ‰ ê²°ê³¼ ì¶œë ¥
        function makeTr(list) {
            var tr = $("<tr>");
            tr.append(`
        <td class="text-center">
          <input type="radio" name="radio">
        </td>
        <td class="text-center">${list.memberId}</td>
      `)
            return tr;
        }

        //ë“±ë¡ë²„íŠ¼ í´ë¦­ì‹œ ì²´í¬ëœ memberIdê°’ì„ ë„˜ê²¨ ajaxí˜¸ì¶œ
        $("#regMemberBtn").on("click", function () {

            var radio = $('input[name=radio]:checked');
            var tr = radio.parent().parent();
            var td = tr.children();
            var code = td.eq(1).text();

            // ë‚œì´ë„ ê°’


            console.log(code);

            let insertedList = $(".inserted")

            insertedList.each(function (index, item) {
                if ($(this).text() === code) {
                    alert("ì´ë¯¸ ì…ë ¥ëœ idì…ë‹ˆë‹¤")
                    code = null;
                }
            });

            if (!code) {
                alert("IDë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”")
            } else {

                let btnId = $("#btnId").val();
                let diff = $('#difficultyVal').val();
                let diffCd = $('#difficultyVal').data('code');
                $("#" + btnId).text(code + ' [' + diff + ']');
                $("#" + btnId).attr('class', 'inserted');
                $("#" + btnId).attr('data-code', diff);
                memberInsertList.push({'id': code, 'difficulty': diffCd});
                console.log(memberInsertList);
                $("#search-modal").fadeOut();
            }

        });
    </script>

</th:block>
</html>