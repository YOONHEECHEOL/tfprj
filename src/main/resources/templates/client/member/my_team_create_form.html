<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layout/cli_layout">


<th:block layout:fragment="content">

    <div th:class="row">
        <div th:class="col-auto">
            <h1>팀</h1>
        </div>
    </div>
    <div th:class="row">
        <div th:class="col-auto">
            <h3>팀 생성</h3>
        </div>
    </div>
    <div th:class="row">
        <div th:class="col-auto">
            <form method="POST" action="/cli/myTeamCreate">
                <div>
                    <table>
                        <tbody>
                        <tr>
                            <th>팀명</th>
                            <td><input th:type="text" th:id="teamName" th:name="teamName"></td>
                        </tr>
                        <tr>
                            <th>팀장</th>
                            <td><input th:type="text" th:id="leader" th:name="leader" th:value="|${session.memberId}|">
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <input th:type="hidden" th:id="memberId" th:name="memberId" th:value="|${session.memberId}|">
                    <button th:type="submit" th:id="createBtn">저장하기</button>
                </div>
                <hr>


            </form>
        </div>
    </div>

    <script>
        //팀 추가 버튼 클릭시 멤버 검색 Modal
        let cliSliderNavBg = document.querySelector('#cli-slider-nav-bg')

        $(".addMemBtn").on("click", function () {
            $(".modal").fadeIn();
            cliSliderNavBg.classList.toggle('active')
        })

        //취소버튼 클릭 시 Modal 닫기
        $("#cancelBtn").on("click", function () {
            $(".modal").fadeOut();
            cliSliderNavBg.classList.remove('active');
        })

        //등록버튼 클릭시 체크된 memberId값을 넘겨 ajax호출
        $("#regMemberBtn").on("click", function () {
            var checkbox = $('input[id=checkbox]:checked');
            var tr = checkbox.parent().parent();
            var td = tr.children();
            var code = td.eq(1).text();

            var tdArray = new Array();
            checkbox.each(function(i){
                tr = checkbox.parent().parent().eq(i);
                td = tr.children();
                code = td.eq(1).text();

                //teamName

                tdArray.push({memberId: code, teamName: '', teamLeader: '',});
            });
            console.log(tdArray);
            for(list of tdArray){
                makeAdd(list);
            }
            $(".modal").fadeOut();
            cliSliderNavBg.classList.remove('active');
        });

        //search 버튼 클릭시 멤버 검색 ajax호출
        $("#searchBtn").on("click", function () {
            $.ajax({
                url: "/cli/searchMember",
                data: {memberId: $("#searchVal").val()}
            }).done(function (data) {
                $("#memberList").html('');
                for (list of data) {
                    $("#memberList").append(makeTr(list));
                }
            })
        })

        //검색 결과 출력
        function makeTr(list) {
            var tr = $("<tr>");
            tr.append(`<td class="text-center"><input type="checkbox" id="checkbox"></td>
            <td class="text-center">${list.memberId}</td>`)
            return tr;
        }
        //팀원추가 결과 draw
        function makeAdd(list){
            $("#addMem").prepend(`<span>${list.memberId}</span><br>`)

            insertTeamMember(teamName, teamLeader, list.memberId);
        }


        // 메세지 테이블에 팀 메세지를 입력하는 함수
        // 각각의 메세지가 입력되야하는 시점에서 실행해주세요
        function insertTeamMember(teamName, teamLeader, memberId) {
            // let teamName = document.querySelector('#teamName').innerText
            // let teamLeader = document.querySelector('#teamLeader').innerText

            fetch('/msg/insertTeamMsg', {
                method: 'post',
                headers: {'Content-type': 'application/json'},
                body: JSON.stringify({
                    teamName: teamName,
                    leader: teamLeader,
                    memberId: memberId
                })
            })
                .then(res => res.text())
                .then(res => console.log(res) )
        }


    </script>
</th:block>
</html>