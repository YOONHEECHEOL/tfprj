<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layout/adm_layout">
<body>

<th:block layout:fragment="content">

    <t-h1 ko="리그조회" en="LEAGUE-DETAIL"></t-h1>


    <div class="row" >
        <!-- league 상세정보 -->
        <div class="col-6">
            <!-- league 정보 출력 -->
            <t-h2 th:ko="${l.getLeagueVO().getLeagueName()}"></t-h2>
            <input type="hidden" th:value="${l.getLeagueVO().getLeagueId()}" id="leagueId">
            <ul>
                <li>
                    <span>리그명 : </span><span th:text="${l.getLeagueVO().getLeagueName()}"></span>
                </li>
                <li>
                    <span>상태 : </span><convert-c-code th:data="${l.getLeagueVO().getLeagueStatusCd()}"></convert-c-code></li>
                </li>
                <li>
                    <span></span>
                    <span th:text="${l.getLeagueVO().getParticipationMember()}"></span>
                </li>
                <li>
                    <span></span>
                    <span th:text="${l.getLeagueVO().getParticipationTeam()}"></span>
                </li>
                <li>
                    <span></span>
                    <span th:text="${l.getLeagueVO().getEntryFee()}"></span>
                </li>
                <li>
                    <span></span>
                    <span th:text="${l.getLeagueVO().getStartDate()}"></span>
                    <span th:text="${l.getLeagueVO().getEndDate()}"></span>
                </li>
                <li>
                    <span></span>
                    <span th:text="${l.getLeagueVO().getPrizeGood()}"></span>
                </li>
                <li>
                    <span></span>
                    <span th:text="${l.getLeagueVO().getPrizeMoney()}"></span>
                </li>
            </ul>

            <!-- league 신청한 팀 목록 -->
            <t-h2 ko="신청목록"></t-h2>
            <div id="tournament-table">
                <table class="table text-center a-table">
                    <thead>
                        <tr>
                            <th>팀이름</th>
                            <th>팀장</th>
                            <th>게임 수</th>
                            <th>승수</th>
                            <th> </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="m:${l.getLeagueApplyTeam()}">
                            <td th:text="${m.getTeamName()}"></td>
                            <td th:text="${m.getLeader()}"></td>
                            <td th:text="${m.getTotalGameCnt()}"></td>
                            <td th:text="${m.getWin()}"></td>
                            <td>
                                <input type="hidden" th:value="${m.getIsApprove()}">
                                <input type="hidden" th:value="${m.getTeamId()}">
                                <button class="c-button">리그 참가승인</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- league 대진표 -->
        <div class="col-6" >
            <!-- 대진표 -->
            <t-h2 ko="대진표"></t-h2>

            <!-- 참가 승인된 팀 목록 -->
            <t-h2 ko="리그 참가 팀 목록"></t-h2>
            <table class="table text-center a-table">
                <thead>
                <tr>
                    <th>팀이름</th>
                    <th>팀장</th>
                    <th>게임 수</th>
                    <th>승수</th>
                </tr>
                </thead>
                <tbody  id="league_team">
                <tr th:each="m:${l.getLeagueApplyApproveTeam()}">
                    <td th:text="${m.getTeamName()}"></td>
                    <td th:text="${m.getLeader()}"></td>
                    <td th:text="${m.getTotalGameCnt()}"></td>
                    <td th:text="${m.getWin()}"></td>
                </tr>
                </tbody>
            </table>

        </div>
    </div>

    <script>
        let tg = document.querySelector('#tournament-table');

        const loadTeam = () => {
            document.addEventListener('DOMContentLoaded', () => {
                // printApplyTeam();

                submitLeagueTeam()
            })
        }
        loadTeam()

        // // 리그 신청받은 팀을 출력
        // const printApplyTeam = () => {
        //     let ld = document.querySelector('#leagueId').value;
        //     // league apply table 에서 데이터 뽑기
        //     fetch('/adm/getLeagueApply?leagueId=' + ld)
        //             .then(res => res.json())
        //             .then(res => {
        //                 console.log(res)
        //                 let result = res.leagueApplyVOList;
        //                 let tg = document.querySelector('#tournament-table')
        //                 // league_id 값 불러오기
        //                 let leagueId = document.querySelector('#leagueId').value;
        //
        //                 let ul = document.createElement('ul')
        //                 ul.setAttribute('class', 'a-list')
        //                 // 신청한 team 수 많큼 출력
        //                 result.forEach(l => {
        //                     let rr = document.createElement('li')
        //                     rr.innerHTML =  `
        //                       <div class="row">
        //                         <div class="col-9">
        //                           <team-info teamId="${l.teamId}" leagueId="${leagueId}"></team-info>
        //                           <team-info-approve teamId="${l.teamId}" leagueId="${leagueId}"></team-info-approve>
        //                         </div>
        //                         <button class="c-button col-3">리그 참가승인</button>
        //                       </div>
        //                     `;
        //                     ul.append(rr)
        //                 })
        //                 tg.append(ul)
        //             })
        // }


        // 리그 참가 팀 확정
        const submitLeagueTeam = () => {
            document.querySelector('#tournament-table').addEventListener('click', () => {

                const tg = event.target;

                if(tg.tagName == 'BUTTON'){

                    let targetNode = tg.parentNode.parentNode;
                    let teamId = tg.parentNode.children[1].value;
                    let teamName = targetNode.children[0].innerText;
                    let leagueId =  document.querySelector('#leagueId').value;

                    let isAppr = tg.parentNode.children[0].value;

                    console.log(targetNode)
                    console.log(teamId)
                    console.log(leagueId)
                    console.log(isAppr)

                    // let teamName = targetNode.querySelector('team-info').shadowRoot.querySelector('.info').children[3].innerText;


                    if(isAppr == 1804) {
                        if(confirm(`[${teamName}] 리그 참가를 승인하시겠습니까?`)) {

                            let cn = targetNode.cloneNode(true);

                            // league apply 상태 변경 ajax
                            fetch('/adm/setLeagueApplyTeamStatus', {
                                method: 'post',
                                headers: {'Content-type': 'application/json'},
                                body: JSON.stringify({
                                    teamId: teamId,
                                    leagueId: leagueId
                                })
                            })
                            .then(res => res.text())
                            .then(res => console.log(res))

                            // 참가팀 넣기
                            cn.children[4].remove()
                            console.log(cn)
                            league_team.append(cn);

                            targetNode.remove();
                        }
                    }
                    else {
                        alert('참가비 미결제!')
                    }
                }
            })
        }


        // 참가 팀을 랜덤하게 사다리 그리기

        // 대진표 그리기


    </script>

</th:block>

</body>
</html>