<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layout/adm_layout">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>

<body>
<th:block layout:fragment="content">
    <style>
        #myProgress {
            position: relative;
            width: 100%;
            height: 50px;
            background-color: #ddd;
            text-align: center;
        }

        #myBar {
            position: absolute;
            height: 100%;
            background-color: #4CAF50;
            text-align: center;
        }

        #label {
            text-align: center;
            line-height: 50px;
            color: white;
        }
    </style>
    <!-- msg ë§Œë“¤ê¸°ìš© -->
    <input type="hidden" id="chkWork" value="ì¶œê·¼">

    <a-h1 ko="ê·¼ë¬´ì ì¶œí‡´ê·¼" en="WORKER"></a-h1>
    
    <div id="newTag" class="f14"></div>
    <div id="allTag" class="f14">
        <h1 class="text-center bf-4" style="color: #18181c">í˜„ì¬ ê·¼ë¬´ì</h1>
        <h2 class="text-center bf-3" style='color: #72ca19' id="nowWorker"></h2>
        <div id="myProgress" style="display: none">
            <div id="myBar">
                <div id="label" class="bf-3">0%</div>
            </div>
        </div>
        <div id="div2">
            <p id="dd"></p>
        </div>
        <div id="out" class="text-center bf-3" style="color: #18181c">
            <h2 id="msg" class="bf-2" style="color: #d34747"></h2>
            <h1 id="demo"></h1>

        </div>
        <hr>
        <table class="table" id="getTable"></table>
        <br>
        <button type="button" id="btn" class="c-button">ì¶œê·¼í•˜ê¸°</button>
    </div>
    <script>

        function getNowTimeMilsec() {
            let today = new Date();
            let hours = today.getHours();
            let minutes = today.getMinutes();
            let millsec = today.getTime();

            return millsec;
        }

        // 1. í˜„ì¬ ì‹œê°„ì„ ë°€ë¦¬ì„¸ì»¨ë“œë¡œ ì–»ëŠ” function
        function getNowTime() {
            let today = new Date();
            let hours = today.getHours();
            let minutes = today.getMinutes();
            let millsec = today.getTime();
            console.log("ì‹¤ì œ í‡´ê·¼ë²„íŠ¼ ì°ì€ ë¶„ " + ((millsec / (1000 * 60))));
            return ((millsec / (1000 * 60)));
        }

        // 2. í‡´ê·¼ ë²„íŠ¼ì„ ì°ì—ˆì„ë•Œì˜ ì‹œê°„ì„ ë°€ë¦¬ì„¸ì»¨ë“œë¡œ ì–»ëŠ” function
        function getOuttime(time) {
            let today = new Date(time)
            console.log("í‡´ê·¼ì‹œê°„ ë¶„" + ((today.getTime() / (1000 * 60))));

            var getOutTime = ((today.getTime() / (1000 * 60)));
            return getOutTime;
        }


        // 3. ì¶œê·¼ ë²„íŠ¼ì„ ì°ì—ˆì„ ë•Œ, ê·¼ë¬´ì¢…ë£Œê¹Œì§€ì˜ ì‹œê°„ì„ ê³„ì‚°í•˜ëŠ” ê²Œì´ì§€ ë°”ê°€ ë‚˜ì˜¤ëŠ” function
        function move(percent, leftTime) {
            console.log(leftTime);
            console.log(percent)
            document.getElementById('myProgress').style.display = "block";
            var elem = document.getElementById("myBar");
            var width = percent;


            var id = setInterval(frame, leftTime * 10);
            elem.style.width = percent + '%';

            function frame() {
                if (width >= 100) {
                    clearInterval(id);
                    document.getElementById('myProgress').style.display = "none";
                    document.getElementById('dd').innerHTML = 'í‡´ê·¼í•˜ì„¸ìš”!';
                    document.getElementById('btn').style.display = "none";

                } else {
                    width++;
                    elem.style.width = width + '%';
                    document.getElementById("label").innerHTML = width * 1 + '%';
                }
            }
        }

        // 4. í‡´ê·¼ë²„íŠ¼ì„ ì°ì—ˆì„ë•Œ ajaxë¡œ ì „ì†¡í•˜ëŠ” function
        function quitAjax(workerId) {
            <!-- í‡´ê·¼ ë©”ì„¸ì§€ ì „ì†¡ -->
            insertAttendWorker();

            $.ajax({
                url: "updateQuit",
                data: {
                    workerId: workerId
                }
            }).done(function (response) {
                console.log(response);
                $('#allTag').remove();
                var h1 = "<h1 class='text-center bf-5'>" + 'ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤.' + "</h1>"
                $('#newTag').append(h1);
            })
        }

        // 5. ë‚¨ì€ì‹œê°„ íƒ€ì´ë¨¸ ê³„ì‚°.
        function timer(time) {
            var time = time;
            var hour = "";
            var min = "";
            var sec = "";

            var x = setInterval(function () {
                hour = parseInt(time / 60 / 60);
                min = parseInt(time / 60 % 60);
                sec = time % 60;

                $('#msg').html("ğŸ“¢í‡´ê·¼ê¹Œì§€")
                $('#demo').html(hour + "ì‹œê°„" + min + "ë¶„" + sec + "ì´ˆ");
                time--;

                if (time < 0) {
                    clearInterval(x);
                    $('#demo').html("ì‹œê°„ì´ˆê³¼");
                }
            }, 1000);
        }

        // 6. í‡´ê·¼ ë²„íŠ¼ì„ í´ë¦­í–ˆì„ë•Œ function
        function outButtonClick(quittingTime, workerId) {
            $('#out').on('click', '#outBtn', function () {
                if (getOuttime(quittingTime) - getNowTime() > 20) {
                    if (!confirm("í‡´ê·¼ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. í‡´ê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        // ì·¨ì†Œ(ì•„ë‹ˆì˜¤) ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸
                        alert('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        // í™•ì¸(ì˜ˆ) ë²„íŠ¼ í´ë¦­ ì‹œ ajax ì´ë²¤íŠ¸
                        quitAjax(workerId)
                    }
                } else {
                    quitAjax(workerId)
                }


            })
        }

        // 7. ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•´ì„œ ì¶œê·¼í•œ ë°ì´í„°ê°€ ë‚¨ì•„ìˆìœ¼ë©´ í™”ë©´ìƒíƒœë¥¼ move ë°”, timer, í‡´ê·¼ë²„íŠ¼ì´ ìˆë„ë¡
        function maintainFnc(workerId) {
            $.ajax({
                url: "selectInUser",
                data: {workerId: workerId}
            }).done(function (response) {
                console.log(response);
                $('#label').html(response.vo.percent + '%');
                if (response.vo.inMTime != null && response.vo.outTime == null) {
                    move(response.vo.percent, response.vo.getMTime);
                    document.getElementById('btn').style.display = "none";
                    timer(response.vo.getMTime);

                    var btn = "<button id='outBtn' class='c-button'>" + 'í‡´ê·¼' + "</button>";
                    insertChkWorker('í‡´ê·¼');

                    $('#out').append(btn);

                    outButtonClick(response.vo.quittingTime, workerId);
                }
            })
        }

        maintainFnc('[[${session.workerId}]]');

        // 8. ì¶œê·¼ë²„íŠ¼ì„ ì°ì—ˆì„ë•Œ, ajaxë¡œ ì„¸ì…˜ì— ë‹´ê²¨ìˆëŠ” ìœ ì €ì•„ì´ë”” ì „ì†¡,
        // ì¶œê²° í…Œì´ë¸”ì— ë“±ë¡
        $('#btn').on('click', function () {
            console.log('[[${session.workerId}]]');
            var workerId = '[[${session.workerId}]]'

            $.ajax({
                url: "selectQuitTime",
                data: {workerId: workerId},
                method: "post"
            }).done(function (response) {
                console.log(response);
                if (response != '') {
                    if (response[response.length - 1].outTime == null && response != '') {
                        alert('ì „ ê·¼ë¬´ìê°€ í‡´ê·¼ì²´í¬ë¥¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
                    } else {
                        alert('ì˜¤ëŠ˜ ì´ë¯¸ í‡´ê·¼ì²˜ë¦¬ í•˜ì…¨ìŠµë‹ˆë‹¤.')
                    }
                } else {
                    $.ajax({
                        url: "insertAttendance",
                        data: {
                            workerId: workerId,
                            getNowTime: getNowTimeMilsec()
                        },
                        method: 'POST'
                    }).done(function (response) {
                        <!-- ì¶œê·¼ ë©”ì„¸ì§€ ì „ì†¡ -->
                        insertAttendWorker();

                        if (response == '') {
                            alert('ì¶œê·¼ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.')
                        } else if (response.late == 0) {
                            console.log("ì¶œê·¼ ë²„íŠ¼ ëˆ„ë¥¸ í›„" + response);
                            checkWorkTime(response)
                        } else if (response.late == 1) {
                            alert("ì§€ê°ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            checkWorkTime(response)
                        } else if (response.absence == 1) {
                            alert("ê²°ê·¼ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            checkWorkTime(response)
                        } else if (response.late == 3) {
                            alert('ê·¼ë¬´í‘œì— ë“±ë¡ë˜ì§€ ì•Šì€ ê·¼ë¬´ìì…ë‹ˆë‹¤.')
                        }
                    })
                }
            })
        })

        //ê·¼ë¬´ ì‹œê°„ì— ë”°ë¼ ì§€ê°, ê²°ê·¼, ì¶œê·¼ì‹œê°„ì´ ì•„ë‹ë•Œ, ì‹œíŠ¸í‘œì— ì—†ëŠ” ê·¼ë¬´ìê°€ ì¶œê·¼í• ë•Œ, ë‹¤ë¥¸ì‚¬ëŒì´ ê·¼ë¬´ì¤‘ì¼ë•Œë¥¼ ì²´í¬í•¨.
        function checkWorkTime(response) {
            $('#label').html(response.vo.percent + '%');
            move(response.vo.percent, response.vo.getMTime);
            console.log(response);
            alert('ì¶œê·¼ ì™„ë£Œ');

            document.getElementById('btn').style.display = "none";

            timer(response.vo.getMTime);

            var btn = "<button id='outBtn' class='c-button'>" + 'í‡´ê·¼' + "</button>";
            $('#out').append(btn);

            //í‡´ê·¼ë²„íŠ¼ì„ ì°ì—ˆì„ë•Œ ì¡°ê¸°í‡´ê·¼ ë“±ì„ ê³„ì‚°í•´ì£¼ëŠ” function

            outButtonClick(response.vo.quittingTime, workerId);
        }

        //ì˜¤ëŠ˜ë‚ ì§œ êµ¬í•˜ê¸°
        function getToday() {
            var today = new Date();
            var dateString = today.getFullYear() + "-" + ('0' + (today.getMonth() + 1)).slice(-2) + "-" + ('0' + today.getDate()).slice(-2);
            return dateString;
        }

        //ì´ë²ˆ ì£¼ 7ì¼ + ìš”ì¼ êµ¬í•´ì„œ tríƒœê·¸ ë™ì ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ê¸°.
        function weekFind() {
            var currentDay = new Date();
            var theYear = currentDay.getFullYear();
            var theMonth = currentDay.getMonth();
            var theDate = currentDay.getDate();
            var theDayOfWeek = currentDay.getDay();

            var thisWeek = [];
            var week = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            for (var i = 0; i < 7; i++) {
                var resultDay = new Date(theYear, theMonth, theDate + (i - theDayOfWeek));
                var yyyy = resultDay.getFullYear();
                var mm = Number(resultDay.getMonth()) + 1;
                var dd = resultDay.getDate();
                var dayOfWeek = week[new Date(yyyy + '-' + mm + '-' + dd).getDay()];

                mm = String(mm).length === 1 ? '0' + mm : mm;
                dd = String(dd).length === 1 ? '0' + dd : dd;

                thisWeek[i] = yyyy + '-' + mm + '-' + dd + "(" + dayOfWeek + ")";
            }
            return thisWeek;
        }


        // ì´ë²ˆì£¼ ë‚ ì§œê°€ ë“¤ì–´ê°„ íƒœê·¸ ë§Œë“¤ê¸°.
        // ì˜¤ëŠ˜ì€ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œë¨.
        //<td>íƒœê·¸ ì•ˆì— ì‹¤ì œê·¼ë¬´ìê°€ í•œë²ˆ ë” í‘œì‹œë˜ê²Œ.
        function weekTrMaker() {
            let chkArr = [];

            // ì´ë²ˆì£¼ ì¶œë ¥
            var tr = "<tr>";
            let j = 0;
            for (let j = 0; j < weekFind().length; j++) {
                if (weekFind()[j].indexOf(getToday()) == -1) {
                    tr += "<td class='firstTr text-center bf-1' width='100'>" + weekFind()[j] + "</td>";
                } else {
                    tr += "<td class='firstTr text-center bf-1' width='100' style='color: #ca2819'>" + weekFind()[j] + "</td>";
                }

                // ê²€ìƒ‰ìš© arr
                chkArr.push(weekFind()[j]);
            }
            tr += "</tr>"
            $('#getTable').append(tr);
            console.log(chkArr)


            // ì¶œê·¼í•œ ì‚¬ëŒ ë¶ˆëŸ¬ì˜¤ëŠ” ë¶€ë¶„
            $.ajax({
                url: "getWeekList"
            }).done(function (response) {
                console.log(response);

                let memberId = "[[${session.workerId}]]";

                let tr = document.createElement('tr');
                let tr2 = document.createElement('tr');
                chkArr.forEach(l => {


                    let td = document.createElement('td')
                    let td2 = document.createElement('td');
                    td.setAttribute('class', 'text-center bf-1')
                    td2.setAttribute('class', 'text-center bf-1')
                    td.style.color = "#18181c"
                    td2.style.color = "#18181c"
                    response.forEach(i => {
                        let tmp = l.substring(2, 10)
                        console.log('tmp================')
                        console.log(i.attDt)
                        console.log(tmp)
                        console.log('//================')
                        if(i.attDt == tmp && memberId == i.workerId) {
                            td.innerHTML = i.inTime;
                            if (i.outTime != null) {
                                td2.innerHTML = i.outTime;
                            } else {
                                td2.innerHTML = 'ê·¼ë¬´ ì¤‘';
                            }
                            //ì˜¤ëŠ˜ë‚ ì§œ ì¼ - ì´ë²ˆì£¼ í† ~ì¼ì´ ì–‘ìˆ˜ì¼ë•Œ
                        }else if(new Date().toISOString().substring(8,10) - l.substring(8, 10) > 0 && td.innerHTML == ''){
                            td.innerHTML = "íœ´ë¬´";
                            td2.innerHTML = "íœ´ë¬´";
                        }
                    })
                    tr.append(td);
                    tr2.append(td2);
                    document.querySelector('#getTable').append(tr);
                    document.querySelector('#getTable').append(tr2);
                })

            })

            $.ajax({
                url : "getNowWorkerName"
            }).done(function(response){
                if(response.workerId != null){
                    $('#nowWorker').html(response.workerId + "ë‹˜");
                }
            })

        }

        weekTrMaker();

        function insertAttendWorker() {
            var workerId = '[[${session.workerId}]]';

            // field ê°’ ì „í•˜ê¸°
            let chkWork = document.querySelector('#chkWork').value;

            fetch('/msg/insertAttendMsg', {
                method: 'post',
                headers: {'Content-type': 'application/json'},
                body: JSON.stringify({
                    workerId: workerId,
                    chkWork: chkWork
                })
            })
                .then(res => res.text())
                .then(res => console.log(res))
        }

        <!-- ì¶œí‡´ê·¼ ë¬¸ì ê°€ì ¸ì˜¤ê¸° -->
        function insertChkWorker(input) {
            let tg = document.querySelector('#chkWork')

            tg.value = input;
        }

    </script>
</th:block>
</body>
</html>
