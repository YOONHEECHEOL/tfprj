<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layout/adm_layout">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
        <div class="row" id="tg">
            <div class="col-6">
                <table>
                    <thead>
                        <tr>
                            <th>체크박스</th>
                            <th>NO</th>
                            <th>CONTENT</th>
                            <th>해결여부</th>
                            <th>상세정보창</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
            let chkCnt = 0;
            let chkChk = 0;

            function makeContent() {
                $.ajax({
                    url: "bringTodayList"
                }).done(function (response) {
                    console.log(response);
                    var content = "";
                    for (let i = 0; i < response.length; i++) {
                        let checked = '';
                        let textDeco = '';
                        if (response[i].isChk == 1) {
                            checked = 'checked';
                            textDeco = 'text-decoration:' + 'line-through';
                        }
                        content = "<tr>";
                        content += `<td><input type='checkbox' value="${response[i].isChk}" id="${response[i].chkNo}" ${checked} class="checkList">` + "</td>"
                        content += "<td>" + response[i].chkNo + "</td>"
                        content += `<td style=${textDeco} class="${response[i].chkPicFileName}">` + response[i].chkContents + "</td>"
                        content += "<td><button type='submit'>해결여부</button></td>"
                        content += `<td><button type='submit' onclick='openPannel()' chk-no='${response[i].chkNo}'>상세정보</button></td>`
                        content += "</tr>"
                        $('tbody').append(content)

                    }
                })
            }

            function openPannel() {
                chkCnt = event.target.getAttribute('chk-no');
                console.log(chkCnt)

                // col-6 한번 생성된 후 && 같지않은 번호를 선택 -> pannel 이 해당 패널로 변경되어야함
                if (tg.children.length >= 2 && chkCnt != chkChk) {
                    tg.children[1].remove()

                    makePannel(chkCnt);
                    chkChk = chkCnt;
                } else if (tg.children.length >= 2 && chkChk == chkCnt) { // col-6 한번 생성된 후 && 같은 번호를 선택 -> pannel이 닫혀야함
                    console.log('같은번호 선택 -> 변화없음')
                    tg.children[1].remove()
                    chkChk = 0;
                } else { // col-6 한번도 생성되지 않음
                    chkChk = chkCnt;

                    makePannel(chkCnt);
                }
            }

            function makePannel(chkCnt) {
                let pannel = document.createElement('div')
                pannel.setAttribute('class', 'col-6')
                pannel.setAttribute('style', 'background: lightgray;')

                $.ajax({
                    url: "selectCheckListInfo",
                    data: {
                        chkNo: chkCnt
                    }
                }).done(function (response) {
                    console.log(response);
                    let fileName = response.chkPicFileName;

                    pannel.innerHTML = `
                    <form method="post" action="/adm/todoFileUpload" enctype="multipart/form-data">
                        <h4>${response.chkNo}</h4>
                        <h3>title</h3>
                        <h1>${response.chkContents}</h1>
                        <input type="hidden" value="${response.chkNo}" name="chkNo">
                        <input type="file" name="file" onchange="setThumbnail(event);"><br><br>
                        <div id="image_container"></div>
                        <div id="image"><img id="realImage"  th:src="@{'/images/adm/'  + ${response.chkPicFileName}}" style="width:250px; height:300px;"/></div>
                        <button type="submit" class="btn button-primary" style="float: right;">업로드</button>
                    </form>
                `
                })

                tg.append(pannel)
            }

            // 파일 업로드 후 썸네일보기
            function setThumbnail(event) {
                $('#image').remove();
                var reader = new FileReader();
                reader.onload = function (event) {
                    var img = document.createElement("img");
                    img.setAttribute("src", event.target.result);
                    img.style.width = '250px'
                    img.style.height = '300px'
                    document.querySelector("div#image_container").appendChild(img);
                };
                reader.readAsDataURL(event.target.files[0]);
            }

            function checkContent() {
                let chkNo = '';
                let isChk = '';
                let textDeco = '';
                $('tbody').on('click', '.checkList', function () {
                    textDeco = $(this);
                    if ($(this).is(":checked") == true) {
                        console.log($(this).parents("td").parents("tr").find("td:eq(3)").attr('class'));
                        //5월 26일 내일
                        chkNo = $(this).attr('id');
                        isChk = "1" // 체크됐을때
                        $(this).parents("td").parents("tr").find("td:eq(2)").css('text-decoration', 'line-through');
                    } else {
                        chkNo = $(this).attr('id');
                        isChk = "0" // 체크 해제됐을때
                        $(this).parents("td").parents("tr").find("td:eq(2)").css('text-decoration', '');
                    }
                    $.ajax({
                        url: "chkNumUpdate",
                        data: {
                            chkNo: chkNo,
                            isChk: isChk,
                            workerId: '[[${session.workerId}]]'
                        }
                        // isChk가 0일때는 workerId도 null로 바꾸기
                    }).done(function (response) {
                        console.log(response);
                    })
                })


            }


            makeContent();
            checkContent();
    </script>
</th:block>
</body>
</html>